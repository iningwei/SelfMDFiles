## 环境
Unity2019.4.2f1

## 前言
公司SDK部分升级了aar。替换后打包报错``unexpected element <queries> found in <manifest>``。经核查确实是在aar中的manifest加了queries标签，SDK部门说该标签主要用于兼容Android11打开浏览器，且他们使用的Gradle插件版本为4.0.1。

## 问题梳理
根据报错信息可以很快定位应该是当前Unity的配置不认识这个新标签，由于Unity都是通过Gradle来生成APK，也就是说当前的Unity版本的Gradle配置无法识别该标签。

### Unity版本和Gradle版本
Unity官方文档：[Gradle for Android](https://docs.unity3d.com/2020.2/Documentation/Manual/android-gradle-overview.html?_ga=2.80777303.1971115895.1607665296-299171731.1595242112)中详细描述了各个版本Unity使用的Gradle版本：

![](https://raw.githubusercontent.com/iningwei/SelfPictureHost/master/Blog/20201211153430.png)

可以看到Unity2019.4.2f1对应使用的Gradle版本为5.1.1。对于Unity来说其Gradle是伴随着Unity安装的时候默认安装到本地的，PC上的目录为：``Editor\Data\PlaybackEngines\AndroidPlayer\Tools\gradle``,默认情况下在Gradle的设置界面（Preferences->External Tools）也是勾选了``Gradle Installed with Unity(recommended)``，即使用Unity默认安装的Gradle

### Android Gradle插件版本和Gradle版本
Android Studio的构建系统是以Gradle为基础，因此衍生出了Android Gradle Plugin，这个插件版本和Gradle自己的版本是独立的且有个对应关系:[Android Gradle 插件版本说明](https://developer.android.com/studio/releases/gradle-plugin#updating-gradle)。
![](https://raw.githubusercontent.com/iningwei/SelfPictureHost/master/Blog/20201211154545.png)

打开该Unity的baseProjectTemplate.gradle(路径为``Editor\Data\PlaybackEngines\AndroidPlayer\Tools\GradleTemplates\baseProjectTemplate.gradle``):
```gradle
// GENERATED BY UNITY. REMOVE THIS COMMENT TO PREVENT OVERWRITING WHEN EXPORTING AGAIN

allprojects {
    buildscript {
        repositories {**ARTIFACTORYREPOSITORY**
            google()
            jcenter()
        }

        dependencies {
            // If you are changing the Android Gradle Plugin version, make sure it is compatible with the Gradle version preinstalled with Unity
            // See which Gradle version is preinstalled with Unity here https://docs.unity3d.com/Manual/android-gradle-overview.html
            // See official Gradle and Android Gradle Plugin compatibility table here https://developer.android.com/studio/releases/gradle-plugin#updating-gradle
            // To specify a custom Gradle version in Unity, go do "Preferences > External Tools", uncheck "Gradle Installed with Unity (recommended)" and specify a path to a custom Gradle version
            classpath 'com.android.tools.build:gradle:3.4.0'
            **BUILD_SCRIPT_DEPS**
        }
    }

    repositories {**ARTIFACTORYREPOSITORY**
        google()
        jcenter()
        flatDir {
            dirs "${project(':unityLibrary').projectDir}/libs"
        }
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
```
通过这一句``classpath 'com.android.tools.build:gradle:3.4.0'``可以看到其配置使用的Android Gradle插件版本为：3.4.0，刚好和Gradle5.1.1版本契合。


### 尝试解决
- step1:考虑到SDK那边说使用的插件版本为4.0.1，因此决定修改baseProjectTemplate.gradle的插件版本为4.0.1
- step2:自己下载Gradle6.1.1来适配Android Gradle 4.0.1，下载后在Unity中把Gradle的目录指向6.1.1的目录

a: 下载可以考虑使用android studio来下载：File->ProjectStructure->Project

![](https://raw.githubusercontent.com/iningwei/SelfPictureHost/master/Blog/20201211164130.png)

通过选择不同的Gradle Version和Plugin Version，Apply后AS会自动给我们下载。下载目录为``C:\用户\.gradle\wrapper\dists``

b: 官方下载地址：https://services.gradle.org/distributions/gradle-6.1.1-all.zip
### 待续
上述操作过后依旧报错``Lint infrastructure error``。无奈升级到Unity2020.1.17f1。顺利出包。费解的是2020.1.17f1对应的Gradle版本是5.6.4，也不满足要求啊。。。
